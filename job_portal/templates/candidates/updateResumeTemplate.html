{% extends "shared/base.html" %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card mt-4">
        <div class="card-body">
          <h5 class="card-title">Update Resume</h5>
          <form method="post" enctype="multipart/form-data" action="updateResume">
            {% csrf_token %}
            {% for field in form %}
            <div class="mb-3">
              <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
              {{ field }}
              {% if field.errors %}
                <span class="error-message">{{ field.errors }}</span>
              {% endif %}
            </div>
            {% endfor %}

            <!-- Add the formsets rendering code -->
            <div id="education-formset">
              {{ education_formset.management_form }}
              {% for education_form in education_formset %}
                {{ education_form.as_table }}
              {% endfor %}
              <div id="empty-education-form" style="display: none;">
                {{ education_formset.empty_form.as_table }}
              </div>
            </div>
            <button type="button" class="btn btn-secondary add-formset-row" data-formset="education" style="margin-bottom: 20px;"><i class="bi bi-plus"></i> Add Education</button>


            <div id="experience-formset">
              {{ experience_formset.management_form }}
              {% for experience_form in experience_formset %}
                {{ experience_form.as_table }}
              {% endfor %}
              <div id="empty-experience-form" style="display: none;">
                {{ experience_formset.empty_form.as_table }}
              </div>
            </div>
            <button type="button" class="btn btn-secondary add-formset-row" data-formset="experience" style="margin-bottom: 20px;"><i class="bi bi-plus"></i> Add Experience</button>

            <div id="skill-formset">
              {{ skill_formset.management_form }}
              {% for skill_form in skill_formset %}
                {{ skill_form.as_table }}
              {% endfor %}
              <div id="empty-skill-form" style="display: none;">
                {{ skill_formset.empty_form.as_table }}
              </div>
            </div>
            <button type="button" class="btn btn-secondary add-formset-row" data-formset="skill" style="margin-bottom: 20px;"><i class="bi bi-plus"></i> Add Skill</button>

            <!-- Rest of the template remains the same -->
            <div>
              <button type="submit" class="btn btn-primary">Update Resume</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add JavaScript to handle the dynamic addition of formsets -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  function updateFormsetPrefix(formsetPrefix) {
    var formsetRows = document.querySelectorAll("#" + formsetPrefix + "-formset .formset-row");
    formsetRows.forEach(function (row, idx) {
      row.id = formsetPrefix + "-form-" + idx;
      var formInputs = row.querySelectorAll("input, select, textarea");
      formInputs.forEach(function (input) {
        input.name = input.name.replace(/__prefix__/g, idx);
        input.id = input.id.replace(/__prefix__/g, idx);
        input.setAttribute("for", input.getAttribute("for").replace(/__prefix__/g, idx));
      });
      var deleteButton = row.querySelector(".delete-formset-row");
      deleteButton.addEventListener("click", function () {
        row.remove();
      });
    });
  }

  function addFormsetRow(formsetPrefix) {
    var formset = document.getElementById(formsetPrefix + "-formset");
    var formIdx = formset.querySelectorAll(".formset-row").length;
    var form = document.getElementById("empty-" + formsetPrefix + "-form").cloneNode(true);
    form.style.display = "block";
    form.classList.add("formset-row");
    form.id = formsetPrefix + "-form-" + formIdx;
    form.innerHTML = form.innerHTML.replace(/__prefix__/g, formIdx);
    formset.appendChild(form);

    // Update the formset's total form count
    var totalFormsInput = formset.querySelector("input[name='" + formsetPrefix + "-TOTAL_FORMS']");
    totalFormsInput.value = formIdx + 1;
    updateFormsetPrefix(formsetPrefix);
  }

  // Add click event listeners for "Add" buttons
  document.querySelectorAll(".add-formset-row").forEach(function (button) {
    var formsetPrefix = button.getAttribute("data-formset");
    button.addEventListener("click", function () {
      addFormsetRow(formsetPrefix);
    });
  });

  // Update formset prefix when the page loads
  ["education", "experience", "skill"].forEach(function (prefix) {
    updateFormsetPrefix(prefix);
  });
});
</script>

{% endblock %}
